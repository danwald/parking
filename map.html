<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Parking Map</title>
		<link rel="stylesheet" href="css/map-style.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
    <h1>Available Parking</h1>
    <div id="map"></div>
    
    <button class="add-spot-btn" onclick="openDialog()">Have a spot available?</button>
    <button class="add-spot-btn" onclick="openBookingDialog()" style="bottom: 80px;">Book a Spot</button>
    
    <div class="dialog-overlay" id="dialogOverlay">
        <div class="dialog">
            <h3>Add Parking Spot</h3>
            <button class="pick-location-btn" id="pickLocationBtn" onclick="togglePickMode()">üìç Click on Map to Pick Location</button>
            <div class="map-instruction" id="mapInstruction" style="display: none;">Click anywhere on the map to set the parking spot location</div>
            <div class="form-group">
                <label for="latitude">Latitude:</label>
                <input type="number" id="latitude" step="any" placeholder="e.g. 25.0982">
            </div>
            <div class="form-group">
                <label for="longitude">Longitude:</label>
                <input type="number" id="longitude" step="any" placeholder="e.g. 55.1562">
            </div>
            <div class="form-group">
                <label for="spotsCount">Number of spots:</label>
                <input type="number" id="spotsCount" min="1" value="1">
            </div>
            <div class="form-group">
                <label for="email">Email address:</label>
                <input type="email" id="email">
            </div>
            <div class="form-group">
                <label for="phonenumber">Phone number:</label>
                <input type="tel" id="phonenumber">
            </div>
            <div class="form-group">
                <label for="captcha">Please solve: <span id="captchaQuestion"></span></label>
                <input type="number" id="captcha" placeholder="Enter the answer" required>
            </div>
            <div class="dialog-buttons">
                <button class="btn btn-secondary" onclick="closeDialog()">Cancel</button>
                <button class="btn btn-primary" onclick="addSpot()">Add Spot</button>
            </div>
        </div>
    </div>

    <div class="dialog-overlay" id="bookingDialogOverlay">
        <div class="dialog">
            <h3>Book Parking Spot</h3>
            <div class="form-group">
                <label for="locationSelect">Select Location:</label>
                <select id="locationSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 16px;">
                    <option value="">Choose a location...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="bookingEmail">Email address:</label>
                <input type="email" id="bookingEmail" required>
            </div>
            <div class="form-group">
                <label for="bookingPhone">Phone number:</label>
                <input type="tel" id="bookingPhone" required>
            </div>
            <div class="form-group">
                <label for="bookingCaptcha">Please solve: <span id="bookingCaptchaQuestion"></span></label>
                <input type="number" id="bookingCaptcha" placeholder="Enter the answer" required>
            </div>
            <div class="dialog-buttons">
                <button class="btn btn-secondary" onclick="closeBookingDialog()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmBooking()">Book Spot</button>
            </div>
        </div>
    </div>

    <script>

				var map = L.map('map').setView([25.05, 55.2], 11);
        let captchaAnswer = 0;
        let bookingCaptchaAnswer = 0;
        let pickingMode = false;
        let tempMarker = null;
        let currentBookingMarker = null;
        let markerData = new Map();

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

				function onLocationFound(e) {
					var radius = e.accuracy;

					L.marker(e.latlng).addTo(map)
							.bindPopup("You are within " + radius + " meters from this point").openPopup();

					L.circle(e.latlng, radius).addTo(map);
				}
				
				map.on('locationfound', onLocationFound);


				function onLocationError(e) {
							alert(e.message);
				}

				map.on('locationerror', onLocationError);

        var marker1 = L.marker([25.09221, 55.17171]).addTo(map);
        markerData.set(marker1, { name: 'The Greens', spots: 2, originalSpots: 2, id: 'greens' });
        marker1.bindPopup('<b>The Greens</b><br>2 parking spots available');

        var marker2 = L.marker([25.00666, 55.28882]).addTo(map);
        markerData.set(marker2, { name: 'Townsquare', spots: 4, originalSpots: 4, id: 'townsquare' });
        marker2.bindPopup('<b>Townsquare</b><br>4 parking spots available');

        window.marker1 = marker1;
        window.marker2 = marker2;

        // Populate location dropdown
        function populateLocationDropdown() {
            const select = document.getElementById('locationSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Choose a location...</option>';
            
            markerData.forEach((data, marker) => {
                if (data.spots > 0) {
                    const option = document.createElement('option');
                    option.value = data.id || data.name.toLowerCase().replace(/\s+/g, '');
                    option.textContent = `${data.name} (${data.spots} spot${data.spots > 1 ? 's' : ''} available)`;
                    select.appendChild(option);
                }
            });
        }

        // Call after DOM is ready
        setTimeout(() => {
            populateLocationDropdown();
        }, 500);

        function generateCaptcha() {
            const num1 = Math.floor(Math.random() * 20) + 1;
            const num2 = Math.floor(Math.random() * 20) + 1;
            captchaAnswer = num1 + num2;
            document.getElementById('captchaQuestion').textContent = `${num1} + ${num2} = ?`;
        }

        function generateBookingCaptcha() {
            const num1 = Math.floor(Math.random() * 20) + 1;
            const num2 = Math.floor(Math.random() * 20) + 1;
            bookingCaptchaAnswer = num1 + num2;
            document.getElementById('bookingCaptchaQuestion').textContent = `${num1} + ${num2} = ?`;
        }

        function togglePickMode() {
            pickingMode = !pickingMode;
            const btn = document.getElementById('pickLocationBtn');
            const instruction = document.getElementById('mapInstruction');
            
            if (pickingMode) {
                btn.textContent = 'üõë Cancel Location Picking';
                btn.classList.add('active');
                instruction.style.display = 'block';
                map.getContainer().style.cursor = 'crosshair';
            } else {
                btn.textContent = 'üìç Click on Map to Pick Location';
                btn.classList.remove('active');
                instruction.style.display = 'none';
                map.getContainer().style.cursor = '';
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
            }
        }

        function onMapClick(e) {
            if (pickingMode && document.getElementById('dialogOverlay').style.display === 'block') {
                e.originalEvent.stopPropagation();
                
                const lat = e.latlng.lat.toFixed(6);
                const lng = e.latlng.lng.toFixed(6);
                
                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lng;
                
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                }
                
                tempMarker = L.marker([lat, lng], {
                    icon: L.icon({
                        iconUrl: 'data:image/svg+xml;base64=' + btoa(`
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#ff6b35">
                                <path d="M12 0c-4.198 0-8 3.403-8 7.602 0 4.198 3.469 9.21 8 16.398 4.531-7.188 8-12.2 8-16.398 0-4.199-3.801-7.602-8-7.602zm0 11c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3z"/>
                            </svg>
                        `),
                        iconSize: [30, 30],
                        iconAnchor: [15, 30]
                    })
                }).addTo(map);
                
                togglePickMode();
            }
        }

        map.on('click', onMapClick);

        function openDialog() {
            const overlay = document.getElementById('dialogOverlay');
            overlay.style.display = 'block';
            overlay.classList.add('active');
            generateCaptcha();
        }

        function closeDialog() {
            const overlay = document.getElementById('dialogOverlay');
            overlay.style.display = 'none';
            overlay.classList.remove('active');
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
            document.getElementById('spotsCount').value = '1';
            document.getElementById('email').value = '';
            document.getElementById('phonenumber').value = '';
            document.getElementById('captcha').value = '';
            
            if (pickingMode) {
                togglePickMode();
            }
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
        }

        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validatePhone(phone) {
            const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
            const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
            return phoneRegex.test(cleanPhone) && cleanPhone.length >= 7;
        }

        function addSpot() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            const spots = parseInt(document.getElementById('spotsCount').value);
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phonenumber').value.trim();
            const captchaInput = parseInt(document.getElementById('captcha').value);

            if (isNaN(lat) || isNaN(lng) || isNaN(spots) || spots < 1) {
                alert('Please enter valid coordinates and number of spots');
                return;
            }

            if (!email || !validateEmail(email)) {
                alert('Please enter a valid email address');
                return;
            }

            if (!phone || !validatePhone(phone)) {
                alert('Please enter a valid phone number (minimum 7 digits)');
                return;
            }

            if (captchaInput !== captchaAnswer) {
                alert('Incorrect captcha answer. Please try again.');
                generateCaptcha();
                document.getElementById('captcha').value = '';
                return;
            }

            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }

            const newMarker = L.marker([lat, lng]).addTo(map);
            const markerId = 'marker_' + Date.now();
            markerData.set(newMarker, { name: 'New Parking Spot', spots: spots, originalSpots: spots, id: markerId });
            
            newMarker.bindPopup(`<b>New Parking Spot</b><br>${spots} parking spot${spots > 1 ? 's' : ''} available`);
            
            window[markerId] = newMarker;
            
            // Update dropdown
            populateLocationDropdown();

            closeDialog();
            map.setView([lat, lng], 15);
        }

        function openBookingDialogForMarker(marker) {
            currentBookingMarker = marker;
            
            if (currentBookingMarker && markerData.has(currentBookingMarker)) {
                const data = markerData.get(currentBookingMarker);
                
                document.getElementById('bookingSpotInfo').textContent = 
                    `Booking 1 spot at ${data.name} (${data.spots} available)`;
                
                const overlay = document.getElementById('bookingDialogOverlay');
                overlay.style.display = 'block';
                overlay.classList.add('active');
            }
        }

        function openBookingDialog() {
            const overlay = document.getElementById('bookingDialogOverlay');
            overlay.style.display = 'block';
            overlay.classList.add('active');
            populateLocationDropdown(); // Refresh dropdown when opening
            generateBookingCaptcha(); // Generate captcha for booking form
        }

        function closeBookingDialog() {
            const overlay = document.getElementById('bookingDialogOverlay');
            overlay.style.display = 'none';
            overlay.classList.remove('active');
            document.getElementById('locationSelect').value = '';
            document.getElementById('bookingEmail').value = '';
            document.getElementById('bookingPhone').value = '';
            document.getElementById('bookingCaptcha').value = '';
            currentBookingMarker = null;
        }

        function confirmBooking() {
            const locationId = document.getElementById('locationSelect').value;
            const email = document.getElementById('bookingEmail').value.trim();
            const phone = document.getElementById('bookingPhone').value.trim();
            const captchaInput = parseInt(document.getElementById('bookingCaptcha').value);

            if (!locationId) {
                alert('Please select a location');
                return;
            }

            if (!email || !validateEmail(email)) {
                alert('Please enter a valid email address');
                return;
            }

            if (!phone || !validatePhone(phone)) {
                alert('Please enter a valid phone number (minimum 7 digits)');
                return;
            }

            if (captchaInput !== bookingCaptchaAnswer) {
                alert('Incorrect captcha answer. Please try again.');
                generateBookingCaptcha();
                document.getElementById('bookingCaptcha').value = '';
                return;
            }

            // Find the selected location
            let selectedLocationName = '';
            markerData.forEach((data, marker) => {
                if (data.id === locationId || data.name.toLowerCase().replace(/\s+/g, '') === locationId) {
                    selectedLocationName = data.name;
                }
            });

            alert(`Parking spot booking request submitted for ${selectedLocationName}!`);
            closeBookingDialog();
        }

        document.getElementById('dialogOverlay').addEventListener('click', function(e) {
            if (e.target === this && !pickingMode) {
                closeDialog();
            }
        });

        document.getElementById('bookingDialogOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeBookingDialog();
            }
        });
    </script>
</body>
</html>
